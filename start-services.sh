#!/bin/sh

# –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ –æ–±–æ–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ –æ–¥–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ

echo "üöÄ –ó–∞–ø—É—Å–∫ Codev —Å–µ—Ä–≤–∏—Å–æ–≤..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -z "$BOT_TOKEN" ]; then
    echo "‚ö†Ô∏è BOT_TOKEN –Ω–µ –∑–∞–¥–∞–Ω, –±–æ—Ç –Ω–µ –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω"
    BOT_DISABLED=true
fi

if [ -z "$DATABASE_URL" ] && [ -z "$DB" ]; then
    echo "‚ö†Ô∏è DATABASE_URL/DB –Ω–µ –∑–∞–¥–∞–Ω"
fi

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
start_web() {
    echo "üåê –ó–∞–ø—É—Å–∫ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
    cd /app/web
    node server.js &
    WEB_PID=$!
    echo "‚úÖ –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ (PID: $WEB_PID)"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞
start_bot() {
    if [ "$BOT_DISABLED" = "true" ]; then
        echo "‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ (BOT_TOKEN –Ω–µ –∑–∞–¥–∞–Ω)"
        return
    fi
    
    echo "ü§ñ –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞..."
    cd /app/bot
    python3 main.py &
    BOT_PID=$!
    echo "‚úÖ Telegram –±–æ—Ç –∑–∞–ø—É—â–µ–Ω (PID: $BOT_PID)"
}

# –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤
cleanup() {
    echo "üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏..."
    
    if [ ! -z "$WEB_PID" ]; then
        echo "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (PID: $WEB_PID)"
        kill $WEB_PID 2>/dev/null
    fi
    
    if [ ! -z "$BOT_PID" ]; then
        echo "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞ (PID: $BOT_PID)"
        kill $BOT_PID 2>/dev/null
    fi
    
    echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    exit 0
}

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤
trap cleanup SIGTERM SIGINT SIGQUIT

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
start_web
start_bot

echo "üéâ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã!"
echo "üåê –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: http://localhost:3000"

if [ "$BOT_DISABLED" != "true" ]; then
    echo "ü§ñ Telegram –±–æ—Ç: –ê–∫—Ç–∏–≤–µ–Ω"
else
    echo "ü§ñ Telegram –±–æ—Ç: –û—Ç–∫–ª—é—á–µ–Ω"
fi

# –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
wait
